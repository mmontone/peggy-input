<html>
  <head>
    <style>
      .grid-container {
          display: grid;
          grid-template-columns: auto auto;
      }
    </style>
  </head>
  <body>
    <input id="input" type="text" style="width: 400px;"></input>

    <div class="grid-container">
      <div class="grid-item">
        <h4>Grammar</h4>
        <textarea id="grammar" style="width: 500px; height:500px;">
        </textarea>
      </div>
      <div class="grid-item">
        <h4>Result</h4>
        <textarea id="result" style="width: 500px; height: 500px;">
        </textarea>
      </div>
    </div>
    <script src="peggy-input.js"></script>
    <script type="text/javascript">
      var grammar = function (peggyInput) {
          return `start = assignment
assignmentcity = "everyone" / citymembers
assignment = g:assignmentcity " " "but " as:assignees { return [g, {'not': as}] } / assignees
assignee = "everyone" / user / citymembers
assignees = a:assignee WS "," WS as:assignees { return [a].concat(as) } / a:assignee { return [a] }
citymembers = "citizens of " cities:cities { return {'membersOf':cities} }
cities = g:city WS "," WS gs:cities { return [g].concat(gs) } / g:city { return [g] }
city "city" = w1:word " " w2:word &{ let w = w1 + " " + w2; return _.includes(${peggyInput}.completers.city, w); } { return w1 + " " + w2 } / w:word &{ return _.includes(${peggyInput}.completers.city, w) } { return w }
user = "@" username:username { return {'user':username} }
username "username" = username:name &{${peggyInput}.setPartialInput(username); return _.includes(${peggyInput}.completers.username, username)} { return username }
WS = [ \t]*
word = $[a-z]i+
name = word:word " " name:name { return word + " " + name } / word
`;
      };
      // Fill in grammar textarea
      $('#grammar').html(grammar('peggyInput'));

      fetch('/users.json')
        .then(res => res.json())
        .then(data => 
           PeggyInput(
           $('#input'),
           {
              'grammar': grammar,
              'completers': {
                  'username' : _.sortBy(_.map(data.results, u => u.name.first + ' ' + u.name.last)),
                  'city' : _.sortedUniq(_.map(data.results, u => u.location.city))
              },
              'resultHandler': function (result) {
                  $('#result').html(JSON.stringify(result));
              }
          }
           )
        );
    </script>
  </body>
</html>
