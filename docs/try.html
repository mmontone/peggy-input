<html>
  <head>
    <style>
      .grid-container {
          display: grid;
          grid-template-columns: auto auto;
      }
    </style>
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js" referrerpolicy="no-referrer"></script>
    <div><input id="name" style="width: 400px;border: none;font-size:20px; font-weight: bold;" placeholder="Example name"></input></div>
    <div>
      <textarea id="description" style="height: 100px; width: 400px;border:none;" placeholder="Example description">
      </textarea>
    </div>
    <div>
      <label>Test input: </label><input id="input" type="text" style="width: 400px;"></input>
    </div>

    <div class="grid-container">
      <div class="grid-item">
        <h4>Grammar</h4>
        <textarea id="grammar" style="width: 500px; height:400px;"></textarea>
        <div id="error" style="color:red;"></div>
      </div>
      <div class="grid-item">
        <div>
          <h4>Result</h4>
          <textarea id="result" style="width: 500px; height: 200px;">
          </textarea>
        </div>
        <div>
          <h4>Initialize</h4>
          <textarea id="initialize" style="width: 500px; height: 200px;">
          </textarea>
        </div>
        <div>
          <button id="apply" class="btn">Apply</button>
          <button id="download" class="btn">Download</button>
        </div>
      </div>
      <div>
        <h4>Examples</h4>
        <ul id="examples">
        </ul>
        <button id="add_example" class="btn">Add example</button>
      </div>
    </div>
    <script src="peggy-input.js"></script>
    <script type="text/javascript">
      function save(filename, data, contentType) {
          const blob = new Blob([data], {type: contentType});
          if(window.navigator.msSaveOrOpenBlob) {
              window.navigator.msSaveBlob(blob, filename);
          }
          else{
              const elem = window.document.createElement('a');
              elem.href = window.URL.createObjectURL(blob);
              elem.download = filename;
              document.body.appendChild(elem);
              elem.click();
              document.body.removeChild(elem);
          }
      }

      function download() {
          let name = $('#name').val();
          let description = $('#description').val();
          let grammar = $('#grammar').val();
          let initialize = $('#initialize').val();
          var examples = '';
          $('#examples').children().each(function (i, example) {
              let expr = $(example).children('input')[0];
              examples += `<example>${$(expr).val()}</example>`;
          });

          var xml =
              `<pidata>
<name>${name}</name>
<description>
${description}
</description>
<grammar>
${grammar}
</grammar>
<initialize>
${initialize}
</initialize>
<examples>
${examples}
</examples>
</pidata>`;
          console.log(xml);
          save(name + '.xml', xml, 'text/xml');
      }

      function load() {
          let urlParams = new URLSearchParams(window.location.search);
          let loadFile = urlParams.get('load');
          if (loadFile) {
              return fetch("./" + loadFile)
                  .then(response => response.text())
                  .then(str => new DOMParser().parseFromString(str, "text/xml"))
                  .then(xml => {
                      console.log('Loading', xml);
                      $('#name').val(xml.querySelector('name').textContent);
                      $('#description').val(xml.querySelector('description').textContent);
                      $('#grammar').val(xml.querySelector('grammar').textContent);
                      $('#initialize').val(xml.querySelector('initialize').textContent);
                      Array.from(xml.querySelector('examples').children).forEach(function (example) {
                          addExample(example.textContent);
                      });
                  });
          }
      }

      function makePeggyInput (inputEl, opts) {
          return Promise.resolve(eval($('#initialize').val()))
              .then(options =>
                  {
                      return PeggyInput(inputEl, _.merge(options, opts, {grammar: $('#grammar').val()}));
                  }).
              catch(console.error);
      }

      function apply () {
          $('#input').replaceWith('<input id="input" type="text" style="width: 400px;"></input>');
          try {
              $('#error').text('');
              Promise.resolve(eval($('#initialize').val()))
                  .then(options =>
                      {
                          console.log('optoins', options);
                          options.grammar = $('#grammar').val();
                          console.log('Initializing with:', options);
                          window.peggyInput = PeggyInput('#input', options);
                          window.peggyInput.resultHandler = function (result) {
                              $('#result').html(JSON.stringify(result));
                          };
                      })
                  .catch(e => $('#error').text(e.message));
          }
          catch (e) {
              $('#error').text(e.message);
          }
      }

      function addExample (expression) {
          let example = $('<li><input></input><textarea></textarea></li>');
          let input = $(example).children('input')[0];
          let resultArea = $(example).children('textarea')[0];
          $('ul#examples').append(example);
          makePeggyInput(input, {resultHandler: function (res) {
              $(resultArea).html(JSON.stringify(res));
          }});
          if (expression !== undefined) {
              $(input).val(expression);
          }
      }

      $(function () {
          $('#apply').click(apply);
          $('#download').click(download);
          $('#add_example').click(addExample);
          Promise.resolve(load()).then(apply);
      });

      </script>
  </body>
</html>
